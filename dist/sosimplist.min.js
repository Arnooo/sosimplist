/*! sosimplist 2016-01-12 */
function ItemBase(a,b){var c=this;c.parent_=a,c.options_=b,c.id_="sosimplist-item"+(new Date).getTime(),c.checked_=!1,c.text_="",c.view_=null}function ItemFactory(){}function ItemFactory_create(){return new ItemFactory}function ItemText(a,b){ItemBase.apply(this,arguments)}function ItemTextComment(a,b){var c=this;ItemBase.apply(this,arguments),c.comment_=""}function List(a){var b=this;b.options_=a,b.id_="sosimplist-list"+(new Date).getTime(),b.view_=null,b.title_="",b.mapOfItem_={},b.checkedVisible_=!1,b.dropdownButtonVisible_=!1,b.dragData=null,b.addItem()}function Sosimplist(){var a=this;a.sosimplistId_=(new Date).getTime(),a.viewId_="",a.view_=null,a.mapOfList_={},a.options_={data:[],save:E_SAVE_IN.URL,edit:!0,checkable:!0}}function Sosimplist_create(){return new Sosimplist}ItemBase.prototype.buildBase=function(){var a=this;if(null===a.view_){if(a.view_=document.createElement("div"),a.view_.id=a.id_,a.view_.className="sosimplist-item",a.options_.edit){var b=document.createElement("div");b.className="sosimplist-item-selector",a.view_.appendChild(b)}var c=document.createElement("input");c.className="sosimplist-item-checkbox",c.type="checkbox",c.addEventListener("change",function(){a.check_(this.checked),a.parent_&&a.parent_.dispatch("moveItem",a)},!1),c.checked=a.checked_,a.view_.appendChild(c);var d=document.createElement("div");if(d.id="sosimplist-item-text"+a.id_,d.className="sosimplist-item-text sosimplist-editable",a.options_.edit?d.contentEditable=!0:d.className+=" sosimplist-edit-false",d.setAttribute("placeholder","write something"),d.addEventListener("keyup",function(b){13===b.keyCode&&a.parent_?(b.preventDefault(),b.stopPropagation(),a.parent_.dispatch("insertItemAfter",a)):a.text_=this.innerHTML},!1),d.addEventListener("keydown",function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation())},!1),d.addEventListener("keypress",function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation())},!1),""!==a.text_&&(d.innerHTML=a.text_),a.view_.appendChild(d),a.options_.edit){var e=document.createElement("div");e.className="sosimplist-item-delete",e.addEventListener("click",function(){a.parent_&&a.parent_.dispatch("removeItem",a)},!1),a.view_.appendChild(e)}a.check_(a.checked_)}else console.error("Item base ID = "+a.id_+", View already builded !")},ItemBase.prototype.serializeBase=function(){var a=this,b={checked:a.checked_,text:a.text_};return b},ItemBase.prototype.unserializeBase=function(a){try{if(!a)throw new Error("Input obj = "+a+", does not contain data to unserialize!");var b=this;b.id_=a.id_,b.checked_=a.checked,b.text_=a.text}catch(c){console.error(c.name+": "+c.message)}},ItemBase.prototype.getView=function(){return this.view_},ItemBase.prototype.getId=function(){return this.id_},ItemBase.prototype.isChecked=function(){return this.checked_},ItemBase.prototype.focus=function(){try{var a=this,b=document.getElementById("sosimplist-item-text"+a.id_),c=document.createRange(),d=window.getSelection();c.setStart(b,0),c.collapse(!0),d.removeAllRanges(),d.addRange(c),b.focus()}catch(e){console.error(e.name+": "+e.message)}},ItemBase.prototype.check_=function(a){try{var b=this;if(a!==!0&&a!==!1)throw new Error("check = "+a+", cannot set this value!");if(b.checked_=a,b.options_.edit){if(!(b.view_&&b.view_.getElementsByClassName("sosimplist-item-selector")&&b.view_.getElementsByClassName("sosimplist-item-selector")[0]))throw new Error("The view = "+b.view_+" is not initialized correctly!");b.view_.draggable=!b.checked_,b.view_.draggable?b.view_.getElementsByClassName("sosimplist-item-selector")[0].style.visibility="visible":b.view_.getElementsByClassName("sosimplist-item-selector")[0].style.visibility="hidden"}}catch(c){console.error(c.name+": "+c.message)}},ItemFactory.prototype.create=function(a,b,c){return"ItemText"===a?new ItemText(b,c):"ItemTextComment"===a?new ItemTextComment(b,c):void console.error("Item type = "+a+" not supported yet !")};var itemfactory=ItemFactory_create();ItemText.prototype=new ItemBase,ItemText.prototype.buildView=function(){var a=this;a.buildBase()},ItemText.prototype.serialize=function(){var a=this;a.serializeBase()},ItemText.prototype.unserialize=function(a){var b=this;b.unserializeBase(a)},ItemTextComment.prototype=new ItemBase,ItemTextComment.prototype.buildView=function(){var a=this;a.buildBase();var b=a.view_;if(b){var c=document.createElement("div");c.id="sosimplist-item-text"+a.id_,c.className="sosimplist-item-text sosimplist-editable",a.options_.edit?c.contentEditable=!0:c.className+=" sosimplist-edit-false",c.setAttribute("placeholder","write a comment"),""!==a.comment_&&(c.innerHTML=a.comment_),b.insertBefore(c,b.lastChild)}else console.error("Item simple ID = "+a.id_+", View already builded !")},ItemTextComment.prototype.serialize=function(){var a=this;a.serializeBase()},ItemTextComment.prototype.unserialize=function(a){try{if(!a)throw new Error("Input obj = "+a+", does not contain data to unserialize!");var b=this;b.unserializeBase(a),b.comment_=a.comment}catch(c){console.error(c.name+": "+c.message)}},List.prototype.buildView=function(){try{var a=this;if(null===a.view_){a.view_=document.createElement("div"),a.view_.id=a.id_,a.view_.className="sosimplist-list",a.options_.edit?a.view_.draggable=!0:a.view_.className+=" sosimplist-edit-false";var b=document.createElement("div");if(b.id="sosimplist-title"+a.id_,b.className="sosimplist-title sosimplist-editable",a.options_.edit?b.contentEditable=!0:b.className+=" sosimplist-edit-false",b.type="text",b.setAttribute("placeholder","Title"),b.addEventListener("keyup",function(){13===event.keyCode?(event.preventDefault(),event.stopPropagation()):a.title_=this.innerHTML},!1),b.addEventListener("keydown",function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation())},!1),b.addEventListener("keypress",function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation())},!1),""!==a.title_&&(b.innerHTML=a.title_),a.view_.appendChild(b),a.itemContainer_=document.createElement("div"),a.itemContainer_.className="sosimplist-container-item",a.itemContainer_.addEventListener("dragstart",function(b){if(b.target.classList.contains("sosimplist-item")){var c=b.target.closest(".sosimplist-item");c.style.zIndex=1,c.style.boxShadow="3px 3px 3px grey",a.dragData={elementId:c.id,source:"item"};var d=document.createElement("div");d.id="mask",d.style.backgroundColor="red",d.style.opacity=0,d.style.width=c.clientWidth,d.style.height=c.clientHeight,d.style.cursor="move",document.body.appendChild(d),b.dataTransfer.setDragImage(d,0,0)}},!1),a.itemContainer_.addEventListener("dragenter",function(b){if(b.preventDefault(),a.dragData&&"item"===a.dragData.source){var c=document.getElementById(a.dragData.elementId);if(c){var d=b.target.closest(".sosimplist-item"),e=d.parentNode.contains(c);e&&(c.nextSibling===d?c.parentNode.insertBefore(c,d.nextSibling):c.parentNode.insertBefore(c,d))}}},!1),a.itemContainer_.addEventListener("drop",function(b){if(a.dragData&&"item"===a.dragData.source){var c=document.getElementById(a.dragData.elementId);c&&(document.body.removeChild(document.getElementById("mask")),c.style.boxShadow="",c.style.zIndex="0",a.dragData=null)}},!1),a.itemContainer_.addEventListener("dragover",function(a){a.preventDefault()},!1),a.view_.appendChild(a.itemContainer_),a.options_.edit){var c=document.createElement("input");c.id="sosimplist-button-add-item",c.className="sosimplist-button",c.type="button",c.value="Add item",c.addEventListener("click",function(){a.addItem()},!1),a.view_.appendChild(c)}var d=document.createElement("div");d.className="sosimplist-list-dropdown-checked",d.value="click",d.addEventListener("click",function(){a.checkedVisible_=!a.checkedVisible_,a.setVisibility_()},!1);var e=document.createElement("div");e.className="sosimplist-list-pin",d.appendChild(e);var f=document.createElement("label");f.className="sosimplist-list-pin-label",f.innerHTML="Selected items",d.appendChild(f),a.view_.appendChild(d),a.itemContainerChecked_=document.createElement("div"),a.itemContainerChecked_.className="sosimplist-container-item-checked",a.view_.appendChild(a.itemContainerChecked_);for(var g in a.mapOfItem_)a.mapOfItem_[g].isChecked()?a.itemContainerChecked_.appendChild(a.mapOfItem_[g].getView()):a.itemContainer_.appendChild(a.mapOfItem_[g].getView());a.setVisibility_()}else console.error("List ID = "+a.id_+", View already builded !")}catch(h){console.error(h.name+": "+h.message)}},List.prototype.serialize=function(){try{for(var a=this,b={title:a.title_,items:[]},c=0;c<a.itemContainer_.children.length;c++)b.items.push(a.mapOfItem_[a.itemContainer_.children[c].id].serialize());for(var d=0;d<a.itemContainerChecked_.children.length;d++)b.items.push(a.mapOfItem_[a.itemContainerChecked_.children[d].id].serialize());return b}catch(e){console.error(e.name+": "+e.message)}},List.prototype.unserialize=function(a){try{var b=this;b.id_=a.id_,b.title_=a.title,b.mapOfItem_={};for(var c=0;c<a.items.length;c++){var d=itemfactory.create("Item"+a.items[c].type,b,b.options_);a.items[c].id_=a.items[c].id_?a.items[c].id_:d.getId()+c,d.unserialize(a.items[c]),d.buildView(),b.mapOfItem_[d.getId()]=d}}catch(e){console.error(e.name+": "+e.message)}},List.prototype.getId=function(){return this.id_},List.prototype.addItem=function(a){try{var b=this,c=itemfactory.create("ItemText",b,b.options_);c.buildView(),b.mapOfItem_[c.getId()]=c,null!==b.view_&&(a?b.itemContainer_.insertBefore(c.getView(),a.nextSibling):b.itemContainer_.appendChild(c.getView()),c.focus())}catch(d){console.error(d.name+": "+d.message)}},List.prototype.removeItem=function(a){try{var b=this;b.itemContainer_.contains(document.getElementById(a.getId()))?b.itemContainer_.removeChild(document.getElementById(a.getId())):b.itemContainerChecked_.removeChild(document.getElementById(a.getId())),b.mapOfItem_[a.getId()]=void 0,delete b.mapOfItem_[a.getId()],b.setVisibility_()}catch(c){console.error(c.name+": "+c.message)}},List.prototype.moveItem=function(a){try{var b=this;a.isChecked()?b.itemContainerChecked_.appendChild(document.getElementById(a.getId())):b.itemContainer_.appendChild(document.getElementById(a.getId())),b.setVisibility_()}catch(c){console.error(c.name+": "+c.message)}},List.prototype.insertItemAfter=function(a){try{var b=this;b.addItem(document.getElementById(a.getId()))}catch(c){console.error(c.name+": "+c.message)}},List.prototype.dispatch=function(a,b){try{var c=this;"moveItem"===a?c.moveItem(b):"removeItem"===a?c.removeItem(b):"insertItemAfter"===a&&c.insertItemAfter(b)}catch(d){console.error(d.name+": "+d.message)}},List.prototype.getView=function(){return this.view_},List.prototype.setVisibility_=function(){try{var a=this;a.checkedVisible_?a.view_.getElementsByClassName("sosimplist-container-item-checked")[0].style.display="":a.view_.getElementsByClassName("sosimplist-container-item-checked")[0].style.display="none",a.dropdownButtonVisible_=a.itemContainerChecked_.hasChildNodes(),a.dropdownButtonVisible_?a.view_.getElementsByClassName("sosimplist-list-dropdown-checked")[0].style.display="":a.view_.getElementsByClassName("sosimplist-list-dropdown-checked")[0].style.display="none"}catch(b){console.error(b.name+": "+b.message)}};var E_SAVE_IN={NONE:0,URL:1,FIREBASE:2};Sosimplist.prototype.init=function(a,b){try{var c=this;if(null===c.view_){if(c.viewId_=a,b)for(var d in b){if(void 0===c.options_[d])throw new Error("Option = "+d+" options[opt] = "+b[d]+", does not exist in this version!");c.options_[d]=b[d]}var e=null,f=window.location.href.split("#");c.options_.data&&c.options_.data.length>0?e=JSON.stringify(c.options_.data):f[1]&&(e=atob(f[1])),c.unserialize(e),c.view_=document.getElementById(this.viewId_),c.view_.className+="sosimplist",c.view_.addEventListener("keyup",function(){c.updateLocation_()},!1),c.view_.addEventListener("change",function(){c.updateLocation_()},!1),c.view_.addEventListener("click",function(){c.updateLocation_()},!1),c.view_.addEventListener("dragend",function(){c.updateLocation_()},!1),c.listContainer_=document.createElement("div"),c.listContainer_.id="sosimplist-container-list"+c.sosimplistId_,c.listContainer_.className="sosimplist-container-list",c.listContainer_.addEventListener("dragstart",function(a){},!1),c.listContainer_.addEventListener("dragenter",function(a){a.preventDefault()},!1),c.listContainer_.addEventListener("drop",function(a){},!1),c.listContainer_.addEventListener("dragover",function(a){a.preventDefault()},!1),c.view_.appendChild(c.listContainer_);for(var g in c.mapOfList_)c.listContainer_.appendChild(c.mapOfList_[g].getView());if(c.options_.edit){var h=document.createElement("input");h.className="sosimplist-button",h.id="sosimplist-button-add-list",h.type="button",h.value="Add list",h.addEventListener("click",function(){c.addList()},!1),c.view_.appendChild(h);var i=document.createElement("input");i.className="sosimplist-button",i.id="sosimplist-button-clear",i.type="button",i.value="Clear",i.addEventListener("click",function(){c.clearAll()},!1),c.view_.appendChild(i)}}else console.error("Sosimplist ID = "+c.viewId_+", View already builded !")}catch(j){console.error(j.name+": "+j.message)}},Sosimplist.prototype.serialize=function(){var a=this,b=[];for(var c in a.mapOfList_)b.push(a.mapOfList_[c].serialize());return JSON.stringify(b)},Sosimplist.prototype.unserialize=function(a){try{var b=this;if(!a)throw new Error("Cannot unserialize empty data");var c=JSON.parse(a);b.mapOfList_={};for(var d=0;d<c.length;d++){var e=new List(b.options_);c[d].id_=c[d].id_?c[d].id_:e.getId()+d,e.unserialize(c[d]),e.buildView(),b.mapOfList_[e.getId()]=e}}catch(f){console.error(f.name+": "+f.message)}},Sosimplist.prototype.addList=function(){try{var a=this,b=new List(a.options_);b.buildView(),a.listContainer_.appendChild(b.getView()),a.mapOfList_[b.getId()]=b}catch(c){console.error(c.name+": "+c.message)}},Sosimplist.prototype.clearAll=function(){try{var a=this;a.mapOfList_={};for(var b=document.getElementById("sosimplist-container-list"+a.sosimplistId_);b.firstChild;)b.removeChild(b.firstChild);a.updateLocation_()}catch(c){console.error(c.name+": "+c.message)}},Sosimplist.prototype.getView=function(){return this.view_},Sosimplist.prototype.getId=function(){return this.viewId_},Sosimplist.prototype.updateLocation_=function(a){var b=this;E_SAVE_IN.URL===b.options_.save&&(window.location.href=window.location.href.split("#")[0]+"#"+btoa(b.serialize()))};var sosimplist=Sosimplist_create();